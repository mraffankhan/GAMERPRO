-- Migration: Match Results, Tournament Status, and Stage Management
-- Run this in Supabase SQL Editor

-- 1. Add current_stage to tournaments (tracks which stage is active)
ALTER TABLE public.tournaments
ADD COLUMN IF NOT EXISTS current_stage text DEFAULT 'Qualifiers';

-- 2. Add status to matches (scheduled, live, completed)
ALTER TABLE public.matches
ADD COLUMN IF NOT EXISTS status text DEFAULT 'scheduled';

-- Add check constraint for match status (only if not exists)
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'matches_status_check'
  ) THEN
    ALTER TABLE public.matches
    ADD CONSTRAINT matches_status_check CHECK (status IN ('scheduled', 'live', 'completed'));
  END IF;
END $$;

-- 3. Add match_number for ordering matches within a group
ALTER TABLE public.matches
ADD COLUMN IF NOT EXISTS match_number integer DEFAULT 1;

-- 4. Match Results Table (stores individual team performance per match)
CREATE TABLE IF NOT EXISTS public.match_results (
  id bigint generated by default as identity primary key,
  match_id bigint references public.matches(id) on delete cascade not null,
  team_id bigint references public.teams(id) on delete cascade not null,
  placement integer,
  kills integer default 0,
  points integer default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  UNIQUE(match_id, team_id)
);

ALTER TABLE public.match_results ENABLE ROW LEVEL SECURITY;

-- Public can view results (transparency for all players)
DROP POLICY IF EXISTS "Public view results" ON public.match_results;
CREATE POLICY "Public view results" ON public.match_results FOR SELECT USING (true);

-- Admins can manage results
DROP POLICY IF EXISTS "Admins manage results" ON public.match_results;
CREATE POLICY "Admins manage results" ON public.match_results FOR ALL USING (
  exists (select 1 from public.profiles where id = auth.uid() and role in ('admin', 'super_admin'))
);

-- 5. Add stage_number to qualifications for proper ordering
ALTER TABLE public.qualifications
ADD COLUMN IF NOT EXISTS stage_number integer DEFAULT 1;

-- 6. Create a view for easy credential access check (helper for frontend)
CREATE OR REPLACE VIEW public.upcoming_matches AS
SELECT 
  m.id as match_id,
  m.group_id,
  m.start_time,
  m.status,
  m.match_number,
  g.tournament_id,
  g.stage_name,
  g.name as group_name,
  t.name as tournament_name,
  CASE 
    WHEN now() >= (m.start_time - interval '15 minutes') THEN true 
    ELSE false 
  END as credentials_available
FROM public.matches m
JOIN public.groups g ON m.group_id = g.id
JOIN public.tournaments t ON g.tournament_id = t.id
WHERE m.status IN ('scheduled', 'live');

-- 7. Grant access to the view
GRANT SELECT ON public.upcoming_matches TO authenticated;
GRANT SELECT ON public.upcoming_matches TO anon;
